# GitHub Actions - CI/CD para Qualia Core
# Roda testes automaticamente a cada push/PR
# 2000 minutos/mÃªs GRÃTIS! 

name: Qualia Core Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  
  # Permite executar manualmente
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        python-version: [3.9, 3.10, 3.11]
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸ Setup Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'
    
    - name: ğŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -e .
        
        # DependÃªncias extras para testes
        pip install pytest pytest-asyncio pytest-cov httpx
    
    - name: ğŸ§ª Run core tests
      run: |
        echo "ğŸ”¬ Testando Core Engine..."
        python -c "
        from qualia.core import QualiaCore
        core = QualiaCore()
        plugins = core.discover_plugins()
        print(f'âœ… Core OK - {len(plugins)} plugins descobertos')
        "
    
    - name: ğŸ”Œ Test plugins individually
      run: |
        echo "ğŸ”Œ Testando plugins individualmente..."
        python -c "
        from qualia.core import QualiaCore, Document
        
        core = QualiaCore()
        core.discover_plugins()
        doc = core.add_document('test', 'Este Ã© um texto de teste para anÃ¡lise.')
        
        plugins_to_test = ['word_frequency', 'sentiment_analyzer']
        
        for plugin_id in plugins_to_test:
            if plugin_id in core.plugins:
                try:
                    result = core.execute_plugin(plugin_id, doc, {})
                    print(f'âœ… Plugin {plugin_id}: OK')
                except Exception as e:
                    print(f'âŒ Plugin {plugin_id}: {e}')
                    exit(1)
            else:
                print(f'âš ï¸  Plugin {plugin_id} nÃ£o encontrado')
        "
    
    - name: ğŸŒ Test API endpoints
      run: |
        echo "ğŸŒ Testando API..."
        
        # Inicia API em background
        python -c "
        import subprocess
        import time
        import requests
        import signal
        import os
        
        # Inicia API
        print('ğŸš€ Iniciando API...')
        proc = subprocess.Popen(['python', '-c', '''
from qualia.api import app
import uvicorn
uvicorn.run(app, host=\"0.0.0.0\", port=8000, log_level=\"error\")
        '''], stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL)
        
        # Aguarda API subir
        time.sleep(10)
        
        try:
            # Testa health check
            response = requests.get('http://localhost:8000/health', timeout=5)
            assert response.status_code == 200, f'Health check falhou: {response.status_code}'
            print('âœ… Health check: OK')
            
            # Testa listagem de plugins
            response = requests.get('http://localhost:8000/plugins', timeout=5)
            assert response.status_code == 200, f'Plugins endpoint falhou: {response.status_code}'
            plugins = response.json()
            print(f'âœ… Plugins endpoint: {len(plugins)} plugins')
            
            # Testa anÃ¡lise bÃ¡sica
            if plugins:
                analyzer_plugins = [p for p in plugins if p['type'] == 'analyzer']
                if analyzer_plugins:
                    plugin_id = analyzer_plugins[0]['id']
                    response = requests.post(
                        f'http://localhost:8000/analyze/{plugin_id}',
                        json={'text': 'teste'},
                        timeout=10
                    )
                    assert response.status_code == 200, f'Analyze falhou: {response.status_code}'
                    print(f'âœ… AnÃ¡lise {plugin_id}: OK')
        
        finally:
            # Mata processo da API
            proc.terminate()
            proc.wait()
        "
    
    - name: ğŸ”„ Test circuit breaker
      run: |
        echo "ğŸ”„ Testando Circuit Breaker..."
        python -c "
        from circuit_breaker import circuit_breaker, get_circuit_stats
        import time
        
        @circuit_breaker(max_failures=2, timeout_seconds=1)
        def test_plugin():
            raise Exception('Teste de falha')
        
        # Testa falhas
        for i in range(3):
            try:
                test_plugin()
            except:
                pass
        
        stats = get_circuit_stats()
        print('âœ… Circuit breaker funcionando')
        "
    
    - name: ğŸ“Š Generate test report
      if: always()
      run: |
        echo "ğŸ“Š RelatÃ³rio de Testes" > test_report.txt
        echo "===================" >> test_report.txt
        echo "Python: ${{ matrix.python-version }}" >> test_report.txt
        echo "Data: $(date)" >> test_report.txt
        echo "Branch: ${{ github.ref_name }}" >> test_report.txt
        echo "Commit: ${{ github.sha }}" >> test_report.txt
        
        if [ $? -eq 0 ]; then
          echo "Status: âœ… TODOS OS TESTES PASSARAM" >> test_report.txt
        else
          echo "Status: âŒ ALGUNS TESTES FALHARAM" >> test_report.txt
        fi
        
        cat test_report.txt
    
    - name: ğŸ“¤ Upload test artifacts
      if: failure()
      uses: actions/upload-artifact@v3
      with:
        name: test-failure-logs-python-${{ matrix.python-version }}
        path: |
          test_report.txt
          *.log
        retention-days: 7

  # Job para testar Docker build
  docker:
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸ³ Test Docker build
      run: |
        echo "ğŸ³ Testando build do Docker..."
        docker build -t qualia-test .
        
        echo "ğŸ§ª Testando container..."
        docker run --rm qualia-test python -c "
        from qualia.core import QualiaCore
        core = QualiaCore()
        plugins = core.discover_plugins()
        print(f'âœ… Docker OK - {len(plugins)} plugins')
        "

  # Job de notificaÃ§Ã£o (opcional)
  notify:
    runs-on: ubuntu-latest
    needs: [test, docker]
    if: always()
    
    steps:
    - name: ğŸ“¢ Status notification
      run: |
        if [[ "${{ needs.test.result }}" == "success" && "${{ needs.docker.result }}" == "success" ]]; then
          echo "ğŸ‰ Todos os testes passaram!"
          echo "âœ… Core engine funcionando"
          echo "âœ… Plugins carregando"
          echo "âœ… API respondendo"
          echo "âœ… Docker buildando"
          echo "âœ… Circuit breaker ativo"
        else
          echo "âŒ Alguns testes falharam"
          echo "Test result: ${{ needs.test.result }}"
          echo "Docker result: ${{ needs.docker.result }}"
          exit 1
        fi

# ConfiguraÃ§Ãµes extras
env:
  # Desabilita coleta de telemetria do pip
  PIP_DISABLE_PIP_VERSION_CHECK: 1
  
  # ForÃ§a modo nÃ£o-interativo
  DEBIAN_FRONTEND: noninteractive
  
  # ConfiguraÃ§Ãµes do Qualia para CI
  QUALIA_ENV: ci
  QUALIA_LOG_LEVEL: ERROR